<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Workout Analyzer</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Base styles for light theme */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #F9FAFB;
            -webkit-tap-highlight-color: transparent;
        }
        .ripple-effect {
            position: relative;
            overflow: hidden;
            transform: translate3d(0, 0, 0);
        }
        .ripple-effect:after {
            content: '';
            display: block;
            position: absolute;
            width: 100%;
            height: 100%;
            top: 0;
            left: 0;
            pointer-events: none;
            background-image: radial-gradient(circle, #fff 10%, transparent 10.01%);
            background-repeat: no-repeat;
            background-position: 50%;
            transform: scale(10, 10);
            opacity: 0;
            transition: transform .5s, opacity 1s;
        }
        .ripple-effect:active:after {
            transform: scale(0, 0);
            opacity: .2;
            transition: 0s;
        }

        /* Loading spinner */
        .loading-spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top: 4px solid #fff;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Collapsible JSON Tree Styling */
        .json-tree {
            list-style: none;
            padding-left: 1.5rem;
            margin-top: 0.5rem;
        }
        .json-tree-item {
            padding: 0.25rem 0;
        }
        .json-tree details > summary {
            list-style: none;
            cursor: pointer;
            user-select: none;
        }
        .json-tree details > summary::-webkit-details-marker {
            display: none;
        }
        .json-tree details > summary:before {
            content: '▸';
            display: inline-block;
            margin-right: 0.5rem;
            transform: rotate(0deg);
            transition: transform 0.2s ease;
        }
        .json-tree details[open] > summary:before {
            content: '▾';
            transform: rotate(0deg);
        }
        .json-tree-key {
            font-weight: bold;
            color: #4B5563; /* Gray */
        }
        .json-tree-string {
            color: #10B981; /* Green for strings */
        }
        .json-tree-number {
            color: #3B82F6; /* Blue for numbers */
        }
        .json-tree-boolean, .json-tree-null {
            color: #EF4444; /* Red for booleans/null */
        }
        .code-block {
            background-color: #F3F4F6;
            color: #1F2937;
            padding: 1rem;
            border-radius: 0.5rem;
            font-family: monospace;
            overflow-x: auto;
        }

        /* Message box styling */
        .message-box {
            position: fixed;
            top: 2rem;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1000;
            padding: 1rem 1.5rem;
            border-radius: 0.75rem;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }
        .message-box.show {
            opacity: 1;
            visibility: visible;
        }

        /* Dark mode styles */
        .dark body {
            background-color: #1F2937;
        }
        .dark .bg-white {
            background-color: #1F2937;
        }
        .dark .bg-gray-100 {
            background-color: #374151;
        }
        .dark .bg-gray-50 {
            background-color: #374151;
        }
        .dark .text-gray-800 {
            color: #F9FAFB;
        }
        .dark .text-gray-700 {
            color: #D1D5DB;
        }
        .dark .text-gray-600 {
            color: #9CA3AF;
        }
        .dark .text-gray-500 {
            color: #6B7280;
        }
        .dark .divide-gray-200 {
            border-color: #4B5563;
        }
        .dark .bg-indigo-600 {
            background-color: #4F46E5;
        }
        .dark .json-tree-key {
            color: #818CF8;
        }
        .dark .json-tree-string {
            color: #FDE047;
        }
        .dark .json-tree-number {
            color: #38BDF8;
        }
        .dark .json-tree-boolean, .dark .json-tree-null {
            color: #A855F7;
        }
        .dark .code-block {
            background-color: #1F2937;
            color: #D1D5DB;
        }
        .dark .message-box {
            background-color: #111827;
            color: #F9FAFB;
        }
        .dark .shadow-lg {
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.3), 0 4px 6px -2px rgba(0, 0, 0, 0.1);
        }
    </style>
</head>
<body class="p-4 sm:p-6 md:p-8">
    <div class="max-w-4xl mx-auto bg-white dark:bg-gray-900 rounded-2xl shadow-lg p-4 sm:p-6 md:p-8">
        <!-- Header Section -->
        <header class="text-center mb-6 relative">
            <h1 class="text-2xl sm:text-3xl font-bold text-gray-800 dark:text-gray-200">Workout Analyzer</h1>
            <p class="text-sm text-gray-500 dark:text-gray-400 mt-1">Upload a .fit file to analyze your workout data.</p>
            <!-- Theme Toggle Switch -->
            <button id="theme-toggle" class="absolute top-0 right-0 p-2 text-gray-500 hover:text-gray-700 dark:hover:text-gray-200 transition-colors duration-300">
                <svg id="moon-icon" class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"></path>
                </svg>
                <svg id="sun-icon" class="w-6 h-6 hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"></path>
                </svg>
            </button>
        </header>

        <!-- File Upload Section -->
        <div class="mb-6">
            <label for="fit-file-input" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Select a .fit file</label>
            <div class="relative flex items-center gap-4">
                <input type="file" id="fit-file-input" accept=".fit" class="block w-full text-sm text-gray-500 dark:text-gray-400 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-indigo-600 file:text-white dark:file:bg-indigo-700 hover:file:bg-indigo-700 dark:hover:file:bg-indigo-800 transition-all duration-300 rounded-lg shadow-inner focus:outline-none focus:ring-2 focus:ring-indigo-500">
                <button id="upload-button" disabled class="ripple-effect bg-gray-400 text-white font-semibold py-2 px-6 rounded-full shadow-md transition-all duration-300 transform hover:scale-105 disabled:bg-gray-400 disabled:cursor-not-allowed">
                    <span id="button-text">Upload</span>
                    <div id="loading-spinner" class="hidden loading-spinner"></div>
                </button>
            </div>
            <p id="status-message" class="text-sm mt-2 text-gray-500 dark:text-gray-400 text-center">No file selected.</p>
        </div>

        <!-- .FIT File Structure Section -->
        <div id="fit-file-structure" class="bg-gray-50 dark:bg-gray-700 p-6 rounded-2xl shadow-lg mt-6">
            <h2 class="text-xl font-bold text-gray-800 dark:text-gray-200 mb-4">Anatomy of a .FIT File</h2>
            <p class="text-sm text-gray-600 dark:text-gray-400 mb-4">A .FIT file is a structured binary file containing different types of messages. Here's a simplified tree-like representation of its core components:</p>
            <ul class="space-y-4 text-sm text-gray-700 dark:text-gray-300">
                <li>
                    <div class="font-bold">1. File Header</div>
                    <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">Contains metadata about the file, such as its size, protocol version, and a unique identifier.</p>
                </li>
                <li>
                    <div class="font-bold">2. Data Records (Messages)</div>
                    <ul class="ml-4 space-y-2">
                        <li>
                            <div class="font-semibold">2a. Session Messages</div>
                            <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">Provides a summary of the entire activity, including total distance, total time, average heart rate, and total calories. A file typically has one session message.</p>
                        </li>
                        <li>
                            <div class="font-semibold">2b. Lap Messages</div>
                            <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">Summarizes a single lap of the activity. It includes lap-specific data like duration, distance, and averages for that segment. This is the data we're primarily analyzing.</p>
                        </li>
                        <li>
                            <div class="font-semibold">2c. Record Messages</div>
                            <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">Contains detailed, time-series data points captured at regular intervals. This is where you'll find data like real-time speed, cadence, and heart rate for every second of your workout.</p>
                        </li>
                        <li>
                            <div class="font-semibold">2d. Event Messages</div>
                            <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">Marks a specific moment in the workout, such as when the timer starts, stops, or a new lap begins. The `event` and `event_type` fields are found here.</p>
                        </li>
                        <li>
                            <div class="font-semibold">...and many others</div>
                            <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">Other message types exist for more detailed data like GPS coordinates, power metrics, and gear changes.</p>
                        </li>
                    </ul>
                </li>
                <li>
                    <div class="font-bold">3. File CRC (Footer)</div>
                    <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">A checksum used to verify the integrity of the file.</p>
                </li>
            </ul>
        </div>

        <!-- Workout Summary and Details -->
        <div id="workout-content" class="hidden">
            <!-- Summary Metrics Section -->
            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 mb-6 mt-6">
                <div class="bg-gray-50 dark:bg-gray-700 p-4 rounded-xl shadow-md text-center">
                    <p class="text-sm font-medium text-gray-500 dark:text-gray-400">Total Distance</p>
                    <p id="total-distance" class="text-2xl sm:text-3xl font-bold text-gray-800 dark:text-gray-200 mt-1">--</p>
                </div>
                <div class="bg-gray-50 dark:bg-gray-700 p-4 rounded-xl shadow-md text-center">
                    <p class="text-sm font-medium text-gray-500 dark:text-gray-400">Avg Pace</p>
                    <p id="avg-pace" class="text-2xl sm:text-3xl font-bold text-gray-800 dark:text-gray-200 mt-1">--</p>
                </div>
                <div class="bg-gray-50 dark:bg-gray-700 p-4 rounded-xl shadow-md text-center">
                    <p class="text-sm font-medium text-gray-500 dark:text-gray-400">Avg Heart Rate</p>
                    <p id="avg-heart-rate" class="text-2xl sm:text-3xl font-bold text-gray-800 dark:text-gray-200 mt-1">--</p>
                </div>
                <div class="bg-gray-50 dark:bg-gray-700 p-4 rounded-xl shadow-md text-center">
                    <p class="text-sm font-medium text-gray-500 dark:text-gray-400">Calories</p>
                    <p id="total-calories" class="text-2xl sm:text-3xl font-bold text-gray-800 dark:text-gray-200 mt-1">--</p>
                </div>
                <div class="bg-gray-50 dark:bg-gray-700 p-4 rounded-xl shadow-md text-center">
                    <p class="text-sm font-medium text-gray-500 dark:text-gray-400">Avg Speed</p>
                    <p id="avg-speed" class="text-2xl sm:text-3xl font-bold text-gray-800 dark:text-gray-200 mt-1">--</p>
                </div>
                <div class="bg-gray-50 dark:bg-gray-700 p-4 rounded-xl shadow-md text-center">
                    <p id="avg-cadence-title" class="text-sm font-medium text-gray-500 dark:text-gray-400">Avg Cadence</p>
                    <p id="avg-cadence" class="text-2xl sm:text-3xl font-bold text-gray-800 dark:text-gray-200 mt-1">--</p>
                </div>
            </div>

            <!-- Detailed Metrics Section -->
            <div class="bg-gray-50 dark:bg-gray-700 p-4 rounded-xl shadow-md mb-6 mt-6">
                <h3 class="text-lg font-bold text-gray-800 dark:text-gray-200 mb-2">Detailed Metrics</h3>
                <div class="grid grid-cols-2 sm:grid-cols-3 gap-4 text-sm">
                    <div class="text-gray-600 dark:text-gray-400">Max Heart Rate: <span id="max-heart-rate" class="font-semibold text-gray-800 dark:text-gray-200">--</span></div>
                    <div class="text-gray-600 dark:text-gray-400">Min Heart Rate: <span id="min-heart-rate" class="font-semibold text-gray-800 dark:text-gray-200">--</span></div>
                    <div class="text-gray-600 dark:text-gray-400">Max Speed: <span id="max-speed" class="font-semibold text-gray-800 dark:text-gray-200">--</span></div>
                    <div class="text-gray-600 dark:text-gray-400">Total Ascent: <span id="total-ascent" class="font-semibold text-gray-800 dark:text-gray-200">--</span></div>
                    <div class="text-gray-600 dark:text-gray-400">Total Descent: <span id="total-descent" class="font-semibold text-gray-800 dark:text-gray-200">--</span></div>
                </div>
            </div>
            
            <!-- Structured Workout Steps Section -->
            <div id="structured-workout-section" class="bg-gray-50 dark:bg-gray-700 p-6 rounded-2xl shadow-lg mt-6 hidden">
                <h2 class="text-xl font-bold text-gray-800 dark:text-gray-200 mb-4">Structured Workout</h2>
                <div id="structured-workout-container" class="space-y-4">
                    <!-- Structured workout steps will be populated here -->
                </div>
            </div>

            <!-- Workout Data Table -->
            <div class="overflow-x-auto rounded-xl shadow-lg">
                <table class="w-full text-left border-collapse">
                    <thead class="bg-indigo-600 dark:bg-indigo-700 text-white">
                        <tr>
                            <th class="p-3 text-sm font-semibold">Lap</th>
                            <th class="p-3 text-sm font-semibold text-right">Distance (km)</th>
                            <th class="p-3 text-sm font-semibold text-right">Time</th>
                            <th class="p-3 text-sm font-semibold text-right">Avg Pace (/km)</th>
                        </tr>
                    </thead>
                    <tbody id="workout-table-body" class="bg-white dark:bg-gray-900 divide-y divide-gray-200 dark:divide-gray-700">
                        <!-- Data will be populated by JavaScript -->
                    </tbody>
                </table>
            </div>

            <!-- General Summary at the bottom -->
            <div class="bg-gray-50 dark:bg-gray-700 text-gray-800 dark:text-gray-200 rounded-xl shadow-md mt-6 p-4">
                <div class="flex justify-between items-center mb-2">
                    <span class="text-sm font-medium text-gray-600 dark:text-gray-400">Activity Time</span>
                    <span id="activity-time-summary" class="text-xl font-bold">--</span>
                </div>
                <div class="flex justify-between items-center">
                    <span class="text-sm font-medium text-gray-600 dark:text-gray-400">Total Time</span>
                    <span id="total-time-summary" class="text-xl font-bold">--</span>
                </div>
            </div>
            
            <!-- Raw Lap Data Section -->
            <div id="raw-lap-data-section" class="bg-white dark:bg-gray-900 p-6 rounded-2xl shadow-lg mt-6 hidden">
                <details>
                    <summary class="cursor-pointer">
                        <h2 class="inline-block text-xl font-bold text-gray-800 dark:text-gray-200">Raw Lap Data</h2>
                        <p class="inline-block text-sm text-gray-600 dark:text-gray-400 mb-4 ml-2">This is the raw JSON representation of all workout laps found in the file.</p>
                    </summary>
                    <div class="code-block" id="raw-lap-data-container">
                        <!-- The JSON tree for all laps will be generated here -->
                    </div>
                </details>
            </div>
        </div>
        <div class="text-center mt-8 text-sm text-gray-500 dark:text-gray-400">Made by Webster</div>
    </div>
    
    <!-- Custom Message Box for alerts -->
    <div id="message-box" class="message-box bg-gray-800 text-white dark:bg-gray-900 dark:text-white"></div>
    
    <script type="module">
        import FitParser from "https://esm.sh/fit-file-parser";

        const fileInput = document.getElementById('fit-file-input');
        const uploadButton = document.getElementById('upload-button');
        const buttonText = document.getElementById('button-text');
        const loadingSpinner = document.getElementById('loading-spinner');
        const statusMessage = document.getElementById('status-message');
        const workoutContent = document.getElementById('workout-content');
        const tableBody = document.getElementById('workout-table-body');
        const avgPaceEl = document.getElementById('avg-pace');
        const totalDistanceEl = document.getElementById('total-distance');
        const avgHeartRateEl = document.getElementById('avg-heart-rate');
        const totalCaloriesEl = document.getElementById('total-calories');
        const avgSpeedEl = document.getElementById('avg-speed');
        const avgCadenceEl = document.getElementById('avg-cadence');
        const maxHeartRateEl = document.getElementById('max-heart-rate');
        const minHeartRateEl = document.getElementById('min-heart-rate');
        const maxSpeedEl = document.getElementById('max-speed');
        const totalAscentEl = document.getElementById('total-ascent');
        const totalDescentEl = document.getElementById('total-descent');
        const activityTimeSummary = document.getElementById('activity-time-summary');
        const totalTimeSummary = document.getElementById('total-time-summary');
        const fitFileStructure = document.getElementById('fit-file-structure');
        const rawLapDataSection = document.getElementById('raw-lap-data-section');
        const rawLapDataContainer = document.getElementById('raw-lap-data-container');
        const structuredWorkoutSection = document.getElementById('structured-workout-section');
        const structuredWorkoutContainer = document.getElementById('structured-workout-container');
        const messageBox = document.getElementById('message-box');
        const themeToggle = document.getElementById('theme-toggle');
        const moonIcon = document.getElementById('moon-icon');
        const sunIcon = document.getElementById('sun-icon');
        const htmlElement = document.documentElement;

        let workoutData = [];

        // Function to show a custom message box instead of alert()
        function showMessage(text, duration = 3000) {
            messageBox.textContent = text;
            messageBox.classList.add('show');
            setTimeout(() => {
                messageBox.classList.remove('show');
            }, duration);
        }

        // Helper function to convert seconds per kilometer to a formatted pace string
        function secondsPerKmToPace(secondsPerKm) {
            if (isNaN(secondsPerKm) || !isFinite(secondsPerKm)) {
                return '--';
            }
            let minutes = Math.floor(secondsPerKm / 60);
            let seconds = Math.round(secondsPerKm % 60);

            if (seconds === 60) {
                minutes++;
                seconds = 0;
            }

            return `${minutes}'${String(seconds).padStart(2, '0')}"/km`;
        }

        // Helper function to format time in seconds to MM:SS or HH:MM:SS with milliseconds
        function formatTime(totalSeconds) {
            if (isNaN(totalSeconds) || totalSeconds < 0) {
                return '--:--';
            }
            const ms = Math.floor((totalSeconds % 1) * 100);
            const seconds = Math.floor(totalSeconds % 60);
            const minutes = Math.floor((totalSeconds / 60) % 60);
            const hours = Math.floor(totalSeconds / 3600);

            let timeString = `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
            if (hours > 0) {
                timeString = `${String(hours).padStart(2, '0')}:${timeString}`;
            }
            return `${timeString}.${String(ms).padStart(2, '0')}`;
        }
        
        // Function to determine the workout segment type using both event_type and event fields
        function getEventType(lap) {
            const eventType = lap.event_type;
            const eventName = (lap.event || '').toLowerCase();

            const eventTypeMap = {
                1: 'stop',
                4: 'rest',
                10: 'warmup',
                11: 'cooldown',
            };

            const mappedEventType = eventTypeMap[eventType];
            if (mappedEventType) {
                return mappedEventType;
            }

            if (eventName.includes('warmup') || eventName.includes('warm_up')) {
                return 'warmup';
            }
            if (eventName.includes('rest')) {
                return 'rest';
            }
            if (eventName.includes('cooldown') || eventName.includes('cool_down')) {
                return 'cooldown';
            }
            
            if (eventName.includes('lap') || eventName.includes('start')) {
                return 'run';
            }
            
            return 'run';
        }

        // Function to render the lap table
        function updateLapTable() {
            tableBody.innerHTML = '';
            
            if (workoutData.length === 0) {
                tableBody.innerHTML = `<tr><td colspan="4" class="py-4 text-center text-gray-500 dark:text-gray-400">No data for this filter.</td></tr>`;
            } else {
                workoutData.forEach((item, index) => {
                    const row = document.createElement('tr');
                    const baseClasses = "py-3 px-3 text-sm text-gray-700 dark:text-gray-300";

                    row.innerHTML = `
                        <td class="${baseClasses}">${item.lapName}</td>
                        <td class="${baseClasses} text-right">${item.distance.toFixed(2)}</td>
                        <td class="${baseClasses} text-right">${item.time}</td>
                        <td class="${baseClasses} font-medium text-right">${item.avgPace}</td>
                    `;
                    tableBody.appendChild(row);
                });
            }
        }

        // Helper function to format workout step data
        function formatWorkoutStep(step) {
            const durationType = step.duration_type;
            const targetType = step.target_type;
            let duration = '';
            let target = '';

            // Handle duration
            switch(durationType) {
                case 0: // Time
                case 1: // Distance
                    const value = step.duration_value;
                    if (value === 0) {
                        duration = "Open";
                    } else if (durationType === 0) {
                        duration = formatTime(value).split('.')[0];
                    } else if (durationType === 1) {
                        duration = `${(value / 1000).toFixed(2)} km`;
                    }
                    break;
                case 5: // Repetitions
                    duration = `${step.duration_value} Reps`;
                    break;
                case 7: // Power
                    duration = `${step.duration_value} watts`;
                    break;
                case 8: // Heart Rate
                    duration = `${step.duration_value} bpm`;
                    break;
                default:
                    duration = `Unknown Duration`;
            }

            // Handle target
            switch(targetType) {
                case 0: // No Target
                    target = 'No Target';
                    break;
                case 1: // Speed
                    const speed = (step.target_value / 1000).toFixed(2);
                    target = `Target Pace: ${secondsPerKmToPace(1000 / speed)}`;
                    break;
                case 2: // Heart Rate
                    target = `Target HR: ${step.target_value} bpm`;
                    break;
                case 3: // Cadence
                    target = `Target Cadence: ${step.target_value} spm`;
                    break;
                case 4: // Power
                    target = `Target Power: ${step.target_value} watts`;
                    break;
                case 7: // Calories
                    target = `Target Calories: ${step.target_value}`;
                    break;
                default:
                    target = `Unknown Target`;
            }

            return {
                name: step.wkt_step_name || 'Unnamed Step',
                duration,
                target,
                intensity: step.intensity || 'Warmup'
            };
        }

        // Function to display the structured workout steps
        function displayStructuredWorkout(workoutSteps, workoutDetected) {
            structuredWorkoutContainer.innerHTML = '';
            structuredWorkoutSection.classList.remove('hidden');

            if (workoutSteps.length > 0) {
                workoutSteps.forEach((step) => {
                    const formattedStep = formatWorkoutStep(step);
                    const stepDiv = document.createElement('div');
                    stepDiv.className = 'bg-gray-50 dark:bg-gray-700 p-4 rounded-lg shadow-inner';
                    stepDiv.innerHTML = `
                        <div class="flex items-center space-x-2 mb-2">
                            <span class="text-xs font-semibold px-2 py-1 rounded-full text-white capitalize" style="background-color: ${formattedStep.intensity === 'warmup' ? '#3B82F6' : formattedStep.intensity === 'cooldown' ? '#10B981' : '#EF4444'}">${formattedStep.intensity}</span>
                            <h4 class="text-lg font-bold text-gray-800 dark:text-gray-200">${formattedStep.name}</h4>
                        </div>
                        <p class="text-sm text-gray-600 dark:text-gray-400">Duration: <span class="font-semibold text-gray-800 dark:text-gray-200">${formattedStep.duration}</span></p>
                        <p class="text-sm text-gray-600 dark:text-gray-400">Target: <span class="font-semibold text-gray-800 dark:text-gray-200">${formattedStep.target}</span></p>
                    `;
                    structuredWorkoutContainer.appendChild(stepDiv);
                });
            } else if (workoutDetected) {
                structuredWorkoutContainer.innerHTML = '<p class="text-sm text-gray-500 dark:text-gray-400">A structured workout was detected in this file, but the individual steps could not be parsed. This often happens with vendor-specific workout plans. You can view the raw lap data below to see the workout segments as they were recorded.</p>';
            } else {
                structuredWorkoutContainer.innerHTML = '<p class="text-sm text-gray-500 dark:text-gray-400">No structured workout steps found in the file.</p>';
                structuredWorkoutSection.classList.add('hidden');
            }
        }

        // Enable the upload button when a file is selected and log the filename
        fileInput.addEventListener('change', () => {
            if (fileInput.files.length > 0) {
                uploadButton.disabled = false;
                statusMessage.textContent = `${fileInput.files[0].name} ready to upload.`;
                console.log(`${fileInput.files[0].name} is selected.`);
                uploadButton.classList.remove('bg-gray-400', 'disabled:bg-gray-400');
                uploadButton.classList.add('bg-indigo-600', 'hover:bg-indigo-700');
            } else {
                uploadButton.disabled = true;
                statusMessage.textContent = 'No file selected.';
                uploadButton.classList.remove('bg-indigo-600', 'hover:bg-indigo-700');
                uploadButton.classList.add('bg-gray-400', 'disabled:bg-gray-400');
            }
        });

        // Handle file upload and analysis on button click
        uploadButton.addEventListener('click', () => {
            console.clear();
            const file = fileInput.files[0];
            if (!file) {
                showMessage('Please select a file first.');
                return;
            }

            console.log("Uploading...");
            buttonText.textContent = '';
            loadingSpinner.classList.remove('hidden');
            uploadButton.disabled = true;
            statusMessage.textContent = 'Processing file...';
            workoutContent.classList.add('hidden');
            fitFileStructure.classList.add('hidden');
            rawLapDataSection.classList.add('hidden');
            structuredWorkoutSection.classList.add('hidden');

            const reader = new FileReader();
            
            reader.onload = (e) => {
                try {
                    console.log("Analyzing...");
                    const fitParserInstance = new FitParser({
                        force: true,
                        speedUnit: 'km/h',
                        lengthUnit: 'm', 
                        elapsedRecordField: true,
                        mode: 'both'
                    });
                    
                    fitParserInstance.parse(e.target.result, (error, data) => {
                        buttonText.textContent = 'Upload';
                        loadingSpinner.classList.add('hidden');
                        uploadButton.disabled = false;
                        fitFileStructure.classList.add('hidden');

                        if (error) {
                            showMessage('Error parsing file. Please ensure it is a valid .fit file.');
                            console.error(error);
                            return;
                        }

                        const lapsData = data.laps || [];
                        const recordsData = data.records || [];
                        const sessionData = data.sessions && data.sessions.length > 0 ? data.sessions[0] : null;
                        const workoutSteps = data.workout_steps || [];
                        const workoutDetected = (data.workouts && data.workouts.length > 0);

                        let totalSpeed = 0;
                        let recordCount = 0;
                        let maxSpeedFromRecords = 0;
                        recordsData.forEach(record => {
                            if (record.speed !== undefined && record.speed > 0) {
                                totalSpeed += record.speed;
                                recordCount++;
                                if (record.speed > maxSpeedFromRecords) {
                                    maxSpeedFromRecords = record.speed;
                                }
                            }
                        });
                        const avgSpeedFromRecords = recordCount > 0 ? totalSpeed / recordCount : 0;
                        
                        let totalDistanceMeters = 0;
                        if (recordsData.length > 0) {
                            const lastRecord = recordsData[recordsData.length - 1];
                            if (lastRecord.distance !== undefined) {
                                totalDistanceMeters = lastRecord.distance;
                            }
                        }
                        const totalDistanceKm = totalDistanceMeters / 1000;
                        
                        let totalCadence = 0;
                        let cadenceCount = 0;
                        if (recordsData.length > 0) {
                            recordsData.forEach(record => {
                                if (record.cadence !== undefined && record.cadence > 0) {
                                    totalCadence += record.cadence;
                                    cadenceCount++;
                                }
                            });
                        }
                        const avgCadence = cadenceCount > 0 ? (totalCadence / cadenceCount) * 2 : null;

                        if (sessionData) {
                            const totalTimerTime = sessionData.total_timer_time;
                            const avgPace = (totalDistanceKm > 0) ? secondsPerKmToPace(totalTimerTime / totalDistanceKm) : '--';
                            
                            totalDistanceEl.textContent = `${totalDistanceKm.toFixed(2)} km`;
                            avgPaceEl.textContent = avgPace;
                            avgHeartRateEl.textContent = `${sessionData.avg_heart_rate ? sessionData.avg_heart_rate.toFixed(0) : '--'} bpm`;
                            totalCaloriesEl.textContent = `${sessionData.total_calories ? sessionData.total_calories.toFixed(0) : '--'} cal`;
                            
                            avgSpeedEl.textContent = `${avgSpeedFromRecords ? avgSpeedFromRecords.toFixed(2) : '--'} km/h`;
                            maxSpeedEl.textContent = `${maxSpeedFromRecords ? maxSpeedFromRecords.toFixed(2) : '--'} km/h`;
                            
                            avgCadenceEl.textContent = `${avgCadence ? avgCadence.toFixed(0) : '--'} spm`;
                            maxHeartRateEl.textContent = `${sessionData.max_heart_rate ? sessionData.max_heart_rate.toFixed(0) : '--'} bpm`;
                            minHeartRateEl.textContent = `${sessionData.min_heart_rate ? sessionData.min_heart_rate.toFixed(0) : '--'} bpm`;
                            totalAscentEl.textContent = `${sessionData.total_ascent ? sessionData.total_ascent.toFixed(2) : '--'} m`;
                            totalDescentEl.textContent = `${sessionData.total_descent ? sessionData.total_descent.toFixed(2) : '--'} m`;
                            
                            activityTimeSummary.textContent = formatTime(sessionData.total_timer_time);
                            totalTimeSummary.textContent = formatTime(sessionData.total_elapsed_time);

                            statusMessage.textContent = 'File successfully analyzed!';
                            workoutContent.classList.remove('hidden');
                            showMessage('Analysis complete!');
                            
                            if (lapsData.length > 0) {
                                workoutData = lapsData.map((lap, index) => {
                                    const timeInSeconds = lap.total_timer_time || 0;
                                    let distanceKm = (lap.total_distance / 1000) || 0;
                                    const avgPaceSecondsPerKm = (distanceKm > 0) ? (timeInSeconds / distanceKm) : Infinity;
                                    
                                    const eventType = getEventType(lap);
                                    
                                    return {
                                        lapName: `${eventType.charAt(0).toUpperCase() + eventType.slice(1)} Lap ${index + 1}`,
                                        distance: distanceKm,
                                        time: formatTime(timeInSeconds),
                                        timeSeconds: timeInSeconds,
                                        avgPace: secondsPerKmToPace(avgPaceSecondsPerKm),
                                        event: eventType
                                    };
                                });
                                
                                displayRawLapsData(data.laps);
                                rawLapDataSection.classList.remove('hidden');

                            } else {
                                workoutData = [];
                            }

                            updateLapTable();
                            
                            if (workoutSteps.length > 0 || workoutDetected) {
                                displayStructuredWorkout(workoutSteps, workoutDetected);
                            }

                        } else {
                            statusMessage.textContent = 'Session data not found in file.';
                            showMessage('Session data not found in file.');
                        }

                    });
                } catch (e) {
                    buttonText.textContent = 'Upload';
                    loadingSpinner.classList.add('hidden');
                    uploadButton.disabled = false;
                    statusMessage.textContent = 'An unexpected error occurred. Please try a different file.';
                    showMessage('An unexpected error occurred. Please try a different file.');
                    console.error(e);
                }
            };
            reader.readAsArrayBuffer(file);
        });
        
        function createJsonTree(data) {
            const list = document.createElement('ul');
            list.classList.add('json-tree');

            for (const key in data) {
                if (data.hasOwnProperty(key)) {
                    const value = data[key];
                    const item = document.createElement('li');
                    item.classList.add('json-tree-item');

                    if (typeof value === 'object' && value !== null && !(value instanceof Date)) {
                        const details = document.createElement('details');
                        const summary = document.createElement('summary');
                        
                        const keySpan = document.createElement('span');
                        keySpan.classList.add('json-tree-key');
                        keySpan.textContent = `"${key}":`;

                        const typeHint = document.createElement('span');
                        const isArray = Array.isArray(value);
                        typeHint.textContent = isArray ? ` [Array (${Object.keys(value).length})]` : ` {Object}`;
                        
                        summary.appendChild(keySpan);
                        summary.appendChild(typeHint);
                        
                        details.appendChild(summary);
                        details.appendChild(createJsonTree(value));
                        item.appendChild(details);
                    } else {
                        const keySpan = document.createElement('span');
                        keySpan.classList.add('json-tree-key');
                        keySpan.textContent = `"${key}": `;

                        const valueSpan = document.createElement('span');
                        let valueStr;
                        if (value instanceof Date) {
                            valueSpan.classList.add('json-tree-string');
                            valueStr = `"${value.toISOString()}"`;
                        } else if (typeof value === 'string') {
                            valueSpan.classList.add('json-tree-string');
                            valueStr = `"${value}"`;
                        } else if (typeof value === 'number') {
                            valueSpan.classList.add('json-tree-number');
                            valueStr = value.toString();
                        } else if (typeof value === 'boolean' || value === null) {
                            valueSpan.classList.add('json-tree-boolean');
                            valueStr = value === null ? 'null' : value.toString();
                        } else {
                            valueStr = JSON.stringify(value);
                        }
                        
                        valueSpan.textContent = valueStr;
                        item.appendChild(keySpan);
                        item.appendChild(valueSpan);
                    }
                    list.appendChild(item);
                }
            }
            return list;
        }

        function displayRawLapsData(laps) {
            rawLapDataContainer.innerHTML = '';
            
            const lapsList = document.createElement('ul');
            lapsList.classList.add('json-tree');

            laps.forEach((lap, index) => {
                const lapItem = document.createElement('li');
                lapItem.classList.add('json-tree-item');

                const lapDetails = document.createElement('details');
                const lapSummary = document.createElement('summary');
                lapSummary.className = 'font-bold text-lg cursor-pointer text-gray-800 dark:text-gray-200';
                
                const type = getEventType(lap);
                lapSummary.innerHTML = `<span class="json-tree-key">Lap ${index + 1}</span>: <span class="text-gray-400 dark:text-gray-500 capitalize">${type}</span>`;
                
                const lapTree = createJsonTree(lap);
                lapDetails.appendChild(lapSummary);
                lapDetails.appendChild(lapTree);
                
                lapItem.appendChild(lapDetails);
                lapsList.appendChild(lapItem);
            });

            if (laps.length > 0) {
                rawLapDataContainer.appendChild(lapsList);
            } else {
                rawLapDataContainer.innerHTML = '<p class="text-sm text-gray-500 dark:text-gray-400">No lap data found in the file.</p>';
            }
        }

        // Theme switching logic
        function setTheme(theme) {
            if (theme === 'dark') {
                htmlElement.classList.add('dark');
                sunIcon.classList.remove('hidden');
                moonIcon.classList.add('hidden');
            } else {
                htmlElement.classList.remove('dark');
                moonIcon.classList.remove('hidden');
                sunIcon.classList.add('hidden');
            }
            localStorage.setItem('theme', theme);
        }

        themeToggle.addEventListener('click', () => {
            const currentTheme = localStorage.getItem('theme');
            if (currentTheme === 'dark') {
                setTheme('light');
            } else {
                setTheme('dark');
            }
        });

        // Initially hide content until a file is uploaded and set the initial theme
        window.onload = () => {
             workoutContent.classList.add('hidden');
             fitFileStructure.classList.remove('hidden');
             const savedTheme = localStorage.getItem('theme') || 'light';
             setTheme(savedTheme);
        };
    </script>
</body>
</html>
